@page "/{TeamCode}/players/{PlayerId:int}"
@layout TeamLayout
@rendermode InteractiveServer
@inject AuthService AuthService
@inject PlayerService PlayerService
@inject StatsService StatsService
@inject MatchService MatchService
@inject IJSRuntime JS

<PageTitle>@(_player?.Name ?? "Player") - Foosball Manager</PageTitle>

@if (_loading)
{
    <LoadingSpinner />
}
else if (_player != null && _stats != null)
{
    <div class="container py-4">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/@TeamCode">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="/@TeamCode/players">Players</a></li>
                <li class="breadcrumb-item active">@_player.Name</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Player Info Card -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-body text-center">
                        <Avatar AvatarId="@_player.AvatarId" Size="xl" />
                        <h3 class="mt-3 mb-1">@_player.Name</h3>
                        <h4 class="text-success">@_stats.CurrentElo ELO</h4>
                        @if (!_player.IsActive)
                        {
                            <span class="badge bg-secondary">Inactive</span>
                        }

                        <hr />

                        <div class="row text-center">
                            <div class="col-4">
                                <h5 class="mb-0">@_stats.TotalMatches</h5>
                                <small class="text-muted">Matches</small>
                            </div>
                            <div class="col-4">
                                <h5 class="mb-0 text-success">@_stats.Wins</h5>
                                <small class="text-muted">Wins</small>
                            </div>
                            <div class="col-4">
                                <h5 class="mb-0 text-danger">@_stats.Losses</h5>
                                <small class="text-muted">Losses</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Card -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Statistics</h6>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Win Rate</span>
                            <strong>@_stats.WinRate.ToString("F1")%</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Highest ELO</span>
                            <strong class="text-success">@_stats.HighestElo</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Lowest ELO</span>
                            <strong class="text-danger">@_stats.LowestElo</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Current Streak</span>
                            <strong class="@(_stats.CurrentStreak > 0 ? "text-success" : _stats.CurrentStreak < 0 ? "text-danger" : "")">
                                @(_stats.CurrentStreak > 0 ? $"+{_stats.CurrentStreak}" : _stats.CurrentStreak.ToString())
                            </strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Longest Win Streak</span>
                            <strong>@_stats.LongestWinStreak</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Preferred Position</span>
                            <strong>@_stats.PreferredPosition</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Under Table Losses</span>
                            <strong class="text-danger">@_stats.UnderTableCount</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Under Table Wins</span>
                            <strong class="text-success">@_stats.TableSenderCount</strong>
                        </li>
                    </ul>
                </div>

                <!-- Position Stats Card -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-person-badge me-2"></i>Position Stats</h6>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between mb-1">
                                <span><i class="bi bi-shield me-1"></i>As Goalkeeper</span>
                                <small class="text-muted">@_stats.GamesAsGk games</small>
                            </div>
                            @if (_stats.GamesAsGk > 0)
                            {
                                <div class="small">
                                    <span class="text-success">Scored: @_stats.GoalsScoredAsGk (@(((double)_stats.GoalsScoredAsGk / _stats.GamesAsGk).ToString("F1"))/game)</span>
                                    <span class="mx-2">|</span>
                                    <span class="text-danger">Conceded: @_stats.GoalsConcededAsGk (@(((double)_stats.GoalsConcededAsGk / _stats.GamesAsGk).ToString("F1"))/game)</span>
                                </div>
                            }
                        </li>
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between mb-1">
                                <span><i class="bi bi-bullseye me-1"></i>As Attacker</span>
                                <small class="text-muted">@_stats.GamesAsAtk games</small>
                            </div>
                            @if (_stats.GamesAsAtk > 0)
                            {
                                <div class="small">
                                    <span class="text-success">Scored: @_stats.GoalsScoredAsAtk (@(((double)_stats.GoalsScoredAsAtk / _stats.GamesAsAtk).ToString("F1"))/game)</span>
                                    <span class="mx-2">|</span>
                                    <span class="text-danger">Conceded: @_stats.GoalsConcededAsAtk (@(((double)_stats.GoalsConcededAsAtk / _stats.GamesAsAtk).ToString("F1"))/game)</span>
                                </div>
                            }
                        </li>
                    </ul>
                </div>

                <!-- Partner & Enemy Stats -->
                <div class="row mt-3">
                    @if (!string.IsNullOrEmpty(_stats.BestPartner))
                    {
                        <div class="col-6 mb-3">
                            <div class="card border-success h-100">
                                <div class="card-header bg-success text-white py-2">
                                    <small class="mb-0"><i class="bi bi-hand-thumbs-up me-1"></i>Best Partner</small>
                                </div>
                                <div class="card-body text-center py-2">
                                    <h6 class="mb-1">@_stats.BestPartner</h6>
                                    <small class="text-success fw-bold">@_stats.BestPartnerWinRate.ToString("F1")%</small>
                                    <small class="text-muted d-block">@_stats.BestPartnerGames games</small>
                                </div>
                            </div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(_stats.WorstPartner))
                    {
                        <div class="col-6 mb-3">
                            <div class="card border-danger h-100">
                                <div class="card-header bg-danger text-white py-2">
                                    <small class="mb-0"><i class="bi bi-hand-thumbs-down me-1"></i>Worst Partner</small>
                                </div>
                                <div class="card-body text-center py-2">
                                    <h6 class="mb-1">@_stats.WorstPartner</h6>
                                    <small class="text-danger fw-bold">@_stats.WorstPartnerWinRate.ToString("F1")%</small>
                                    <small class="text-muted d-block">@_stats.WorstPartnerGames games</small>
                                </div>
                            </div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(_stats.EasiestEnemy))
                    {
                        <div class="col-6 mb-3">
                            <div class="card border-info h-100">
                                <div class="card-header bg-info text-white py-2">
                                    <small class="mb-0"><i class="bi bi-emoji-smile me-1"></i>Easiest Enemy</small>
                                </div>
                                <div class="card-body text-center py-2">
                                    <h6 class="mb-1">@_stats.EasiestEnemy</h6>
                                    <small class="text-success fw-bold">@_stats.EasiestEnemyWinRate.ToString("F1")%</small>
                                    <small class="text-muted d-block">@_stats.EasiestEnemyGames games</small>
                                </div>
                            </div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(_stats.HardestEnemy))
                    {
                        <div class="col-6 mb-3">
                            <div class="card border-warning h-100">
                                <div class="card-header bg-warning text-dark py-2">
                                    <small class="mb-0"><i class="bi bi-emoji-frown me-1"></i>Hardest Enemy</small>
                                </div>
                                <div class="card-body text-center py-2">
                                    <h6 class="mb-1">@_stats.HardestEnemy</h6>
                                    <small class="text-danger fw-bold">@_stats.HardestEnemyWinRate.ToString("F1")%</small>
                                    <small class="text-muted d-block">@_stats.HardestEnemyGames games</small>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Charts and Match History -->
            <div class="col-lg-8">
                <!-- ELO History Chart -->
                @if (_stats.EloHistory.Count > 1)
                {
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-graph-up-arrow me-2"></i>ELO History</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="eloChart" height="200"></canvas>
                        </div>
                    </div>
                }

                <!-- Match History -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Matches</h6>
                        @if (_totalMatchCount > Constants.Pagination.PlayerDetailRecentMatches)
                        {
                            <a href="/@TeamCode/matches?player=@PlayerId" class="btn btn-sm btn-outline-success">View All (@_totalMatchCount)</a>
                        }
                    </div>
                    <div class="card-body">
                        @if (_recentMatches.Count > 0 && _lastLoadedPlayerId == PlayerId)
                        {
                            @foreach (var match in _recentMatches)
                            {
                                var playerMatch = match.MatchPlayers.FirstOrDefault(mp => mp.PlayerId == PlayerId);
                                if (playerMatch != null)
                                {
                                    var playerTeamWon = (playerMatch.TeamNumber == 1 && match.Team1Score > match.Team2Score) ||
                                                       (playerMatch.TeamNumber == 2 && match.Team2Score > match.Team1Score);
                                    <div class="match-history-item mb-2 p-2 rounded @(playerTeamWon ? "bg-success bg-opacity-10" : "bg-danger bg-opacity-10")">
                                        <MatchCard Match="@match" TeamCode="@TeamCode" Compact="true" />
                                        <div class="d-flex justify-content-between align-items-center small px-2">
                                            <span class="text-muted">
                                                <i class="bi bi-calendar3 me-1"></i>
                                                <span class="match-date" data-utc="@match.PlayedAt.ToString("o")">@match.PlayedAt.ToString("MMM dd, yyyy")</span>
                                            </span>
                                            <span class="@(playerTeamWon ? "text-success" : "text-danger") fw-bold">
                                                @(playerMatch.EloChange > 0 ? $"+{playerMatch.EloChange}" : playerMatch.EloChange.ToString()) ELO
                                            </span>
                                        </div>
                                    </div>
                                }
                            }
                        }
                        else
                        {
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-calendar-x fs-3 d-block mb-2"></i>
                                <p class="mb-0">No matches played yet.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="container py-4">
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Player not found.
        </div>
        <a href="/@TeamCode/players" class="btn btn-primary">Back to Players</a>
    </div>
}

@code {
    [Parameter] public string TeamCode { get; set; } = string.Empty;
    [Parameter] public int PlayerId { get; set; }

    private Team? _team;
    private Player? _player;
    private PlayerStats? _stats;
    private List<Match> _recentMatches = [];
    private int _totalMatchCount;
    private bool _loading = true;
    private int _lastLoadedPlayerId;
    private bool _chartRendered;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || (_lastLoadedPlayerId != PlayerId && !_loading))
        {
            await LoadPlayerDataAsync();
        }
        else if (_stats?.EloHistory.Count > 1 && !_chartRendered)
        {
            await RenderChart();
            _chartRendered = true;
        }
    }

    private async Task LoadPlayerDataAsync()
    {
        _loading = true;
        _chartRendered = false;
        StateHasChanged();

        _team = await AuthService.GetCurrentTeamAsync();
        if (_team != null)
        {
            _player = await PlayerService.GetByIdWithTeamAsync(PlayerId);
            if (_player != null && _player.TeamId == _team.Id)
            {
                _stats = await StatsService.GetPlayerStatsAsync(PlayerId);
                _recentMatches = await MatchService.GetByPlayerAsync(PlayerId, Constants.Pagination.PlayerDetailRecentMatches);
                _totalMatchCount = await MatchService.GetCountByPlayerAsync(PlayerId);
            }
            else
            {
                _player = null;
                _stats = null;
                _recentMatches = [];
                _totalMatchCount = 0;
            }
        }
        _lastLoadedPlayerId = PlayerId;
        _loading = false;
        StateHasChanged();

        // Render chart after data is loaded
        if (_stats?.EloHistory.Count > 1)
        {
            await RenderChart();
            _chartRendered = true;
        }
    }

    private async Task RenderChart()
    {
        if (_stats == null) return;

        var labels = _stats.EloHistory.Select(h => h.Date.ToString("MMM dd")).ToArray();
        var data = _stats.EloHistory.Select(h => h.Elo).ToArray();

        await JS.InvokeVoidAsync("renderEloChart", "eloChart", labels, data);
    }
}
