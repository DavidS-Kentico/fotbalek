@page "/{TeamCode}/stats"
@layout TeamLayout
@rendermode InteractiveServer
@inject AuthService AuthService
@inject StatsService StatsService
@inject PlayerService PlayerService
@inject MatchService MatchService
@inject IJSRuntime JS
@using Fotbalek.Web.Helpers

<PageTitle>Statistics - Foosball Manager</PageTitle>

@if (_loading)
{
    <LoadingSpinner />
}
else
{
    <div class="container py-4">
        <h2 class="mb-4"><i class="bi bi-graph-up me-2"></i>Statistics</h2>

        <!-- Time Period Filter -->
        <div class="card mb-4">
            <div class="card-body py-2">
                <div class="d-flex flex-wrap align-items-center gap-3">
                    <TimePeriodFilter @bind-SelectedPeriod="_selectedPeriod"
                                      @bind-CustomStartDate="_customStartDate"
                                      @bind-CustomEndDate="_customEndDate"
                                      LimitCustomRangeToThreeMonths="true"
                                      OnFilterChanged="OnFilterChanged" />

                    @if (_selectedPeriod != "all")
                    {
                        <span class="badge bg-secondary">
                            @GetFilterDescription()
                        </span>
                    }
                </div>
            </div>
        </div>

        <!-- Badges (filtered by period) -->
        <div class="card mb-4">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="bi bi-award me-2"></i>@(_selectedPeriod == "all" ? "Badge Holders" : "Period Leaders")</h6>
            </div>
            <div class="card-body py-2">
                @* Rankings *@
                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                    <small class="text-muted fw-semibold" style="min-width: 70px;"><i class="bi bi-bar-chart me-1"></i>Rankings</small>
                    <div class="d-flex align-items-center gap-1 px-2 py-1 @(_filteredBadges.TopRated != null ? "bg-warning bg-opacity-10" : "bg-secondary bg-opacity-10 opacity-50") rounded small" title="@(_selectedPeriod == "all" ? "Player with the highest current ELO rating" : "Best ELO gain in period")">
                        <span>&#11088;</span>
                        <span class="fw-semibold">@(_selectedPeriod == "all" ? "Top Rated" : "Top Gainer"):</span>
                        @if (_filteredBadges.TopRated != null)
                        {
                            <span>@_filteredBadges.TopRated.PlayerName <span class="text-muted">(@(_selectedPeriod == "all" ? _filteredBadges.TopRated.Value.ToString() : $"+{_filteredBadges.TopRated.Value}"))</span></span>
                        }
                        else
                        {
                            <span class="text-muted fst-italic">-</span>
                        }
                    </div>
                    <div class="d-flex align-items-center gap-1 px-2 py-1 @(_filteredBadges.BestWinRate != null ? "bg-primary bg-opacity-10" : "bg-secondary bg-opacity-10 opacity-50") rounded small" title="Best win rate (min @Constants.TimeThresholds.MinGamesForPositionBadge games)">
                        <span>&#128200;</span>
                        <span class="fw-semibold">Best Win%:</span>
                        @if (_filteredBadges.BestWinRate != null)
                        {
                            <span>@_filteredBadges.BestWinRate.PlayerName <span class="text-muted">(@_filteredBadges.BestWinRate.Value%)</span></span>
                        }
                        else
                        {
                            <span class="text-muted fst-italic">-</span>
                        }
                    </div>
                    <div class="d-flex align-items-center gap-1 px-2 py-1 @(_filteredBadges.LastPlace != null ? "bg-dark bg-opacity-10" : "bg-secondary bg-opacity-10 opacity-50") rounded small" title="@(_selectedPeriod == "all" ? "Player with the lowest current ELO rating" : "Worst ELO change in period")">
                        <span>&#128168;</span>
                        <span class="fw-semibold">@(_selectedPeriod == "all" ? "Last Place" : "Top Loser"):</span>
                        @if (_filteredBadges.LastPlace != null)
                        {
                            <span>@_filteredBadges.LastPlace.PlayerName <span class="text-muted">(@_filteredBadges.LastPlace.Value)</span></span>
                        }
                        else
                        {
                            <span class="text-muted fst-italic">-</span>
                        }
                    </div>
                </div>

                @* Streaks *@
                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                    <small class="text-muted fw-semibold" style="min-width: 70px;"><i class="bi bi-fire me-1"></i>Streaks</small>
                    <div class="d-flex align-items-center gap-1 px-2 py-1 @(_filteredBadges.HotStreak != null ? "bg-danger bg-opacity-10" : "bg-secondary bg-opacity-10 opacity-50") rounded small" title="Player with the longest active winning streak (min 3 wins)">
                        <span>&#128293;</span>
                        <span class="fw-semibold">Hot Streak:</span>
                        @if (_filteredBadges.HotStreak != null)
                        {
                            <span>@_filteredBadges.HotStreak.PlayerName <span class="text-muted">(@_filteredBadges.HotStreak.Value)</span></span>
                        }
                        else
                        {
                            <span class="text-muted fst-italic">-</span>
                        }
                    </div>
                    <div class="d-flex align-items-center gap-1 px-2 py-1 @(_filteredBadges.StreakKing != null ? "bg-primary bg-opacity-10" : "bg-secondary bg-opacity-10 opacity-50") rounded small" title="@(_selectedPeriod == "all" ? "Player with the longest winning streak in history (min 3 wins)" : "Longest winning streak in period (min 3 wins)")">
                        <span>&#128081;</span>
                        <span class="fw-semibold">Streak King:</span>
                        @if (_filteredBadges.StreakKing != null)
                        {
                            <span>@_filteredBadges.StreakKing.PlayerName <span class="text-muted">(@_filteredBadges.StreakKing.Value)</span></span>
                        }
                        else
                        {
                            <span class="text-muted fst-italic">-</span>
                        }
                    </div>
                </div>

                @* Positions *@
                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                    <small class="text-muted fw-semibold" style="min-width: 70px;"><i class="bi bi-person-badge me-1"></i>Positions</small>
                    <div class="d-flex align-items-center gap-1 px-2 py-1 @(_filteredBadges.BestGoalkeeper != null ? "bg-secondary bg-opacity-10" : "bg-secondary bg-opacity-10 opacity-50") rounded small" title="Goalkeeper with lowest goals conceded per match (min @Constants.TimeThresholds.MinGamesForPositionBadge games)">
                        <span>&#129311;</span>
                        <span class="fw-semibold">Best GK:</span>
                        @if (_filteredBadges.BestGoalkeeper != null)
                        {
                            <span>@_filteredBadges.BestGoalkeeper.PlayerName <span class="text-muted">(@((_filteredBadges.BestGoalkeeper.Value / 10.0).ToString("F1"))/g)</span></span>
                        }
                        else
                        {
                            <span class="text-muted fst-italic">-</span>
                        }
                    </div>
                    <div class="d-flex align-items-center gap-1 px-2 py-1 @(_filteredBadges.BestAttacker != null ? "bg-danger bg-opacity-10" : "bg-secondary bg-opacity-10 opacity-50") rounded small" title="Attacker with highest goals scored per match (min @Constants.TimeThresholds.MinGamesForPositionBadge games)">
                        <span>&#127919;</span>
                        <span class="fw-semibold">Best ATK:</span>
                        @if (_filteredBadges.BestAttacker != null)
                        {
                            <span>@_filteredBadges.BestAttacker.PlayerName <span class="text-muted">(@((_filteredBadges.BestAttacker.Value / 10.0).ToString("F1"))/g)</span></span>
                        }
                        else
                        {
                            <span class="text-muted fst-italic">-</span>
                        }
                    </div>
                </div>

                @* Under Table *@
                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                    <small class="text-muted fw-semibold" style="min-width: 70px;"><i class="bi bi-arrow-down-up me-1"></i>Table</small>
                    <div class="d-flex align-items-center gap-1 px-2 py-1 @(_filteredBadges.TableDivers.Count > 0 ? "bg-info bg-opacity-10" : "bg-secondary bg-opacity-10 opacity-50") rounded small" title="Most losses with 0 score (under the table): @(string.Join(", ", _filteredBadges.TableDivers.Select(t => t.PlayerName)))">
                        <span>&#129681;</span>
                        <span class="fw-semibold">Diver:</span>
                        @if (_filteredBadges.TableDivers.Count > 0)
                        {
                            <span>@string.Join(", ", _filteredBadges.TableDivers.Select(t => t.PlayerName)) <span class="text-muted">(@_filteredBadges.TableDivers[0].Value)</span></span>
                        }
                        else
                        {
                            <span class="text-muted fst-italic">-</span>
                        }
                    </div>
                    <div class="d-flex align-items-center gap-1 px-2 py-1 @(_filteredBadges.TableSenders.Count > 0 ? "bg-success bg-opacity-10" : "bg-secondary bg-opacity-10 opacity-50") rounded small" title="Most 10-0 wins (sent enemies under the table): @(string.Join(", ", _filteredBadges.TableSenders.Select(t => t.PlayerName)))">
                        <span>&#128170;</span>
                        <span class="fw-semibold">Sender:</span>
                        @if (_filteredBadges.TableSenders.Count > 0)
                        {
                            <span>@string.Join(", ", _filteredBadges.TableSenders.Select(t => t.PlayerName)) <span class="text-muted">(@_filteredBadges.TableSenders[0].Value)</span></span>
                        }
                        else
                        {
                            <span class="text-muted fst-italic">-</span>
                        }
                    </div>
                </div>

                @* Special *@
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <small class="text-muted fw-semibold" style="min-width: 70px;"><i class="bi bi-star me-1"></i>Special</small>
                    <div class="d-flex align-items-center gap-1 px-2 py-1 @(_filteredBadges.TomkoMemorials.Count > 0 ? "bg-warning bg-opacity-10" : "bg-secondary bg-opacity-10 opacity-50") rounded small" title="Most games played in a single day (min @Constants.TimeThresholds.MinGamesForTomkoBadge games): @(string.Join(", ", _filteredBadges.TomkoMemorials.Select(t => t.PlayerName)))">
                        <span>&#127942;</span>
                        <span class="fw-semibold">Tomko:</span>
                        @if (_filteredBadges.TomkoMemorials.Count > 0)
                        {
                            <span>@string.Join(", ", _filteredBadges.TomkoMemorials.Select(t => t.PlayerName)) <span class="text-muted">(@_filteredBadges.TomkoMemorials[0].Value/day)</span></span>
                        }
                        else
                        {
                            <span class="text-muted fst-italic">-</span>
                        }
                    </div>
                    <div class="d-flex align-items-center gap-1 px-2 py-1 @(_filteredBadges.Carried.Count > 0 ? "" : "bg-secondary bg-opacity-10 opacity-50") rounded small" style="@(_filteredBadges.Carried.Count > 0 ? "background-color: rgba(111, 66, 193, 0.1);" : "")" title="Most wins when partnered with higher ELO player (min @Constants.TimeThresholds.MinGamesForCarriedBadge wins): @(string.Join(", ", _filteredBadges.Carried.Select(t => t.PlayerName)))">
                        <span>&#129309;</span>
                        <span class="fw-semibold">Carried:</span>
                        @if (_filteredBadges.Carried.Count > 0)
                        {
                            <span>@string.Join(", ", _filteredBadges.Carried.Select(t => t.PlayerName)) <span class="text-muted">(@_filteredBadges.Carried[0].Value wins)</span></span>
                        }
                        else
                        {
                            <span class="text-muted fst-italic">-</span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall Stats -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card bg-success text-white h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-people fs-2 d-block mb-2"></i>
                        <h3 class="mb-0">@_filteredPlayerCount</h3>
                        <small>@(_selectedPeriod == "all" ? "Active Players" : "Players in Period")</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-primary text-white h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-controller fs-2 d-block mb-2"></i>
                        <h3 class="mb-0">@_filteredMatchCount</h3>
                        <small>@(_selectedPeriod == "all" ? "Total Matches" : "Matches in Period")</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-info text-white h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-bullseye fs-2 d-block mb-2"></i>
                        <h3 class="mb-0">@_filteredTotalGoals</h3>
                        <small>@(_selectedPeriod == "all" ? "Total Goals" : "Goals in Period")</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-warning text-dark h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-calculator fs-2 d-block mb-2"></i>
                        <h3 class="mb-0">@_filteredAvgGoalsPerMatch.ToString("F1")</h3>
                        <small>Avg Goals/Match</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1: ELO and Win Rate -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-graph-up-arrow me-2"></i>ELO Distribution</h6>
                    </div>
                    <div class="card-body">
                        @if (_rankings.Count > 0)
                        {
                            <canvas id="eloDistributionChart" height="250"></canvas>
                        }
                        else
                        {
                            <p class="text-muted text-center">No data available</p>
                        }
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Win Rate Distribution</h6>
                    </div>
                    <div class="card-body">
                        @if (_filteredRankings.Count > 0)
                        {
                            <canvas id="winRateChart" height="250"></canvas>
                        }
                        else
                        {
                            <p class="text-muted text-center">No data available</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2: Games per Player and Matches Over Time -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>Games per Player</h6>
                    </div>
                    <div class="card-body">
                        @if (_filteredRankings.Count > 0)
                        {
                            <canvas id="gamesPerPlayerChart" height="250"></canvas>
                        }
                        else
                        {
                            <p class="text-muted text-center">No data available</p>
                        }
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-calendar-week me-2"></i>Matches Over Time</h6>
                    </div>
                    <div class="card-body">
                        @if (_matchesOverTime.Count > 0)
                        {
                            <canvas id="matchesOverTimeChart" height="250"></canvas>
                        }
                        else
                        {
                            <p class="text-muted text-center">No data available</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 3: Day of Week and Most Common Pairs -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Activity by Day of Week</h6>
                    </div>
                    <div class="card-body">
                        @if (_dayOfWeekStats.Any(d => d > 0))
                        {
                            <canvas id="dayOfWeekChart" height="250"></canvas>
                        }
                        else
                        {
                            <p class="text-muted text-center">No data available</p>
                        }
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-people-fill me-2"></i>Most Common Pairs</h6>
                    </div>
                    <div class="card-body">
                        @if (_filteredPairStats.Count > 0)
                        {
                            <canvas id="commonPairsChart" height="250"></canvas>
                        }
                        else
                        {
                            <p class="text-muted text-center">No data available</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string TeamCode { get; set; } = string.Empty;

    private Team? _team;
    private bool _loading = true;

    // All-time data (used for badges and ELO chart)
    private List<PlayerRanking> _rankings = [];
    private TeamBadges? _badges;
    private int _playerCount;

    // All matches loaded once
    private List<Match> _allMatches = [];

    // Filtering state
    private string _selectedPeriod = "all";
    private DateOnly? _customStartDate;
    private DateOnly? _customEndDate;

    // Filtered data
    private List<Match> _filteredMatches = [];
    private List<FilteredPlayerRanking> _filteredRankings = [];
    private List<FilteredPairStats> _filteredPairStats = [];
    private FilteredBadges _filteredBadges = new();
    private int _filteredPlayerCount;
    private int _filteredMatchCount;
    private int _filteredTotalGoals;
    private double _filteredAvgGoalsPerMatch;
    private Dictionary<string, int> _matchesOverTime = [];
    private int[] _dayOfWeekStats = new int[7];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _team = await AuthService.GetCurrentTeamAsync();
            if (_team != null)
            {
                // Load all-time data (for badges and ELO chart)
                _rankings = await StatsService.GetRankingsAsync(_team.Id);
                _badges = await StatsService.GetBadgesAsync(_team.Id);
                _playerCount = await PlayerService.GetActiveCountAsync(_team.Id);

                // Get all matches for filtering
                _allMatches = await MatchService.GetByTeamAsync(_team.Id, 1, 10000);

                // Initialize custom date range
                _customEndDate = DateOnly.FromDateTime(DateTime.Today);
                _customStartDate = _customEndDate.Value.AddMonths(-1);

                // Apply initial filter
                ApplyFilter();
            }
            _loading = false;
            StateHasChanged();

            // Render charts
            await RenderCharts();
        }
    }

    private void ApplyFilter()
    {
        _filteredMatches = _allMatches
            .Where(m => DateFilterHelper.IsDateInPeriod(
                DateOnly.FromDateTime(m.PlayedAt.Date),
                _selectedPeriod,
                _customStartDate,
                _customEndDate))
            .ToList();

        RecalculateStats();
    }

    private void RecalculateStats()
    {
        // Basic stats
        _filteredMatchCount = _filteredMatches.Count;
        _filteredTotalGoals = _filteredMatches.Sum(m => m.Team1Score + m.Team2Score);
        _filteredAvgGoalsPerMatch = _filteredMatchCount > 0 ? (double)_filteredTotalGoals / _filteredMatchCount : 0;

        // Player stats from filtered matches
        var playerStats = new Dictionary<int, (string Name, int AvatarId, int Games, int Wins)>();

        foreach (var match in _filteredMatches)
        {
            foreach (var mp in match.MatchPlayers)
            {
                if (!playerStats.ContainsKey(mp.PlayerId))
                {
                    playerStats[mp.PlayerId] = (mp.Player.Name, mp.Player.AvatarId, 0, 0);
                }

                var current = playerStats[mp.PlayerId];
                var won = mp.EloChange > 0;
                playerStats[mp.PlayerId] = (current.Name, current.AvatarId, current.Games + 1, current.Wins + (won ? 1 : 0));
            }
        }

        _filteredPlayerCount = playerStats.Count;

        _filteredRankings = playerStats
            .Select(kvp => new FilteredPlayerRanking
            {
                PlayerId = kvp.Key,
                PlayerName = kvp.Value.Name,
                AvatarId = kvp.Value.AvatarId,
                Matches = kvp.Value.Games,
                Wins = kvp.Value.Wins,
                WinRate = kvp.Value.Games > 0 ? (double)kvp.Value.Wins / kvp.Value.Games * 100 : 0
            })
            .OrderByDescending(r => r.WinRate)
            .ThenByDescending(r => r.Matches)
            .ToList();

        // Pair stats from filtered matches
        var pairStats = new Dictionary<string, FilteredPairStats>();

        foreach (var match in _filteredMatches)
        {
            ProcessTeamPairFiltered(match, 1, pairStats);
            ProcessTeamPairFiltered(match, 2, pairStats);
        }

        _filteredPairStats = pairStats.Values
            .OrderByDescending(p => p.Matches)
            .Take(8)
            .ToList();

        // Calculate matches over time (dynamic weeks based on filter period)
        CalculateMatchesOverTime();

        // Calculate day of week stats
        CalculateDayOfWeekStats();

        // Calculate filtered badges
        CalculateFilteredBadges();
    }

    private static void ProcessTeamPairFiltered(Match match, int teamNumber, Dictionary<string, FilteredPairStats> pairStats)
    {
        var teamPlayers = match.MatchPlayers
            .Where(mp => mp.TeamNumber == teamNumber)
            .OrderBy(mp => mp.PlayerId)
            .ToList();

        if (teamPlayers.Count != 2) return;

        var key = $"{teamPlayers[0].PlayerId}-{teamPlayers[1].PlayerId}";
        var won = teamPlayers[0].EloChange > 0;

        if (!pairStats.TryGetValue(key, out var pair))
        {
            pair = new FilteredPairStats
            {
                Player1Name = teamPlayers[0].Player.Name,
                Player2Name = teamPlayers[1].Player.Name
            };
            pairStats[key] = pair;
        }
        pair.Matches++;
        if (won) pair.Wins++;
    }

    private void CalculateMatchesOverTime()
    {
        _matchesOverTime.Clear();

        if (_filteredMatches.Count == 0) return;

        var (startDate, endDate) = GetFilterDateRange();
        var totalDays = (endDate.ToDateTime(TimeOnly.MinValue) - startDate.ToDateTime(TimeOnly.MinValue)).Days + 1;

        // If less than 14 days, show daily data instead of weekly
        if (totalDays < 14)
        {
            // Show each day
            for (int i = 0; i < totalDays; i++)
            {
                var day = startDate.AddDays(i);
                var dayLabel = day.ToString("MMM dd");
                var count = _filteredMatches.Count(m => DateOnly.FromDateTime(m.PlayedAt.Date) == day);
                _matchesOverTime[dayLabel] = count;
            }
        }
        else
        {
            // Show weekly data
            var weeksCount = Math.Max(1, (int)Math.Ceiling(totalDays / 7.0));

            // Limit to reasonable number of weeks for display
            weeksCount = Math.Min(weeksCount, 13);

            for (int i = weeksCount - 1; i >= 0; i--)
            {
                var weekEnd = endDate.AddDays(-7 * i);
                var weekStart = weekEnd.AddDays(-6);
                if (weekStart < startDate) weekStart = startDate;

                var weekLabel = weekStart.ToString("MMM dd");
                var count = _filteredMatches.Count(m =>
                    DateOnly.FromDateTime(m.PlayedAt.Date) >= weekStart &&
                    DateOnly.FromDateTime(m.PlayedAt.Date) <= weekEnd);
                _matchesOverTime[weekLabel] = count;
            }
        }
    }

    private (DateOnly startDate, DateOnly endDate) GetFilterDateRange()
    {
        var today = DateOnly.FromDateTime(DateTime.Today);
        var range = DateFilterHelper.GetDateRange(_selectedPeriod, _customStartDate, _customEndDate);

        if (range.HasValue)
            return range.Value;

        // "all" period - use actual data range
        return _allMatches.Count > 0
            ? (DateOnly.FromDateTime(_allMatches.Min(m => m.PlayedAt.Date)), today)
            : (today.AddMonths(-1), today);
    }

    private void CalculateDayOfWeekStats()
    {
        _dayOfWeekStats = new int[7];
        foreach (var match in _filteredMatches)
        {
            var dayIndex = (int)match.PlayedAt.DayOfWeek;
            _dayOfWeekStats[dayIndex]++;
        }
    }

    private async Task OnFilterChanged()
    {
        ApplyFilter();
        StateHasChanged();
        await RenderCharts();
    }

    private string GetFilterDescription()
    {
        var periodDesc = DateFilterHelper.GetPeriodDescription(_selectedPeriod, _customStartDate, _customEndDate);
        return periodDesc != null ? $"{periodDesc} ({_filteredMatchCount} matches)" : $"{_filteredMatchCount} matches";
    }

    private void CalculateFilteredBadges()
    {
        _filteredBadges = new FilteredBadges();

        if (_filteredMatches.Count == 0) return;

        // For "all" period, use the pre-calculated badges (without newcomers)
        if (_selectedPeriod == "all" && _badges != null)
        {
            _filteredBadges.TopRated = _badges.TopRated;
            _filteredBadges.HotStreak = _badges.HotStreak;
            _filteredBadges.StreakKing = _badges.StreakKing;
            _filteredBadges.BestGoalkeeper = _badges.BestGoalkeeper;
            _filteredBadges.BestAttacker = _badges.BestAttacker;
            _filteredBadges.BestWinRate = _badges.BestWinRate;
            _filteredBadges.LastPlace = _badges.LastPlace;
            _filteredBadges.TableDivers = _badges.TableDivers;
            _filteredBadges.TableSenders = _badges.TableSenders;
            _filteredBadges.TomkoMemorials = _badges.TomkoMemorials;
            _filteredBadges.Carried = _badges.Carried;
            return;
        }

        // Calculate badges from filtered matches
        var orderedMatches = _filteredMatches.OrderBy(m => m.PlayedAt).ToList();

        // Track per-player stats
        var playerData = new Dictionary<int, PlayerBadgeData>();

        foreach (var match in orderedMatches)
        {
            var team1Won = match.Team1Score > match.Team2Score;
            var isTableSend = (team1Won && match.Team1Score == 10 && match.Team2Score == 0) ||
                              (!team1Won && match.Team2Score == 10 && match.Team1Score == 0);

            // Track carried wins - process winning team
            var winningTeamNumber = team1Won ? 1 : 2;
            var winningTeamPlayers = match.MatchPlayers.Where(p => p.TeamNumber == winningTeamNumber).ToList();
            if (winningTeamPlayers.Count == 2)
            {
                var player1 = winningTeamPlayers[0];
                var player2 = winningTeamPlayers[1];

                // Player1 was carried if partner (player2) had higher ELO
                if (player2.EloBefore > player1.EloBefore)
                {
                    if (!playerData.ContainsKey(player1.PlayerId))
                        playerData[player1.PlayerId] = new PlayerBadgeData { Name = player1.Player.Name };
                    playerData[player1.PlayerId].CarriedWins++;
                }

                // Player2 was carried if partner (player1) had higher ELO
                if (player1.EloBefore > player2.EloBefore)
                {
                    if (!playerData.ContainsKey(player2.PlayerId))
                        playerData[player2.PlayerId] = new PlayerBadgeData { Name = player2.Player.Name };
                    playerData[player2.PlayerId].CarriedWins++;
                }
            }

            foreach (var mp in match.MatchPlayers)
            {
                if (!playerData.ContainsKey(mp.PlayerId))
                {
                    playerData[mp.PlayerId] = new PlayerBadgeData { Name = mp.Player.Name };
                }

                var data = playerData[mp.PlayerId];
                data.TotalGames++;
                data.TotalEloChange += mp.EloChange;

                var won = mp.EloChange > 0;

                if (won)
                {
                    data.Wins++;
                    data.CurrentStreak++;
                    if (data.CurrentStreak > data.LongestStreak)
                        data.LongestStreak = data.CurrentStreak;
                }
                else
                {
                    data.CurrentStreak = 0;
                }

                // Table diver: lost 0-10
                var playerTeamWon = (mp.TeamNumber == 1 && team1Won) || (mp.TeamNumber == 2 && !team1Won);
                if (!playerTeamWon)
                {
                    var opponentScore = mp.TeamNumber == 1 ? match.Team2Score : match.Team1Score;
                    var playerScore = mp.TeamNumber == 1 ? match.Team1Score : match.Team2Score;
                    if (opponentScore == 10 && playerScore == 0)
                        data.UnderTableLosses++;
                }

                // Table sender: won 10-0
                if (playerTeamWon && isTableSend)
                    data.TableSends++;

                // Position stats
                if (mp.Position == "Goalkeeper")
                {
                    data.GkGames++;
                    data.GkGoalsConceded += mp.TeamNumber == 1 ? match.Team2Score : match.Team1Score;
                }
                else if (mp.Position == "Attacker")
                {
                    data.AtkGames++;
                    data.AtkGoalsScored += mp.TeamNumber == 1 ? match.Team1Score : match.Team2Score;
                }

                // Games per day tracking
                var dateKey = match.PlayedAt.Date;
                if (!data.GamesPerDay.ContainsKey(dateKey))
                    data.GamesPerDay[dateKey] = 0;
                data.GamesPerDay[dateKey]++;
            }
        }

        var minGames = Constants.TimeThresholds.MinGamesForPositionBadge;

        // Top Rated (best ELO change in period)
        var topGainer = playerData.OrderByDescending(p => p.Value.TotalEloChange).FirstOrDefault();
        if (topGainer.Value != null && topGainer.Value.TotalEloChange > 0)
        {
            _filteredBadges.TopRated = new BadgeHolder
            {
                PlayerId = topGainer.Key,
                PlayerName = topGainer.Value.Name,
                Value = topGainer.Value.TotalEloChange
            };
        }

        // Last Place (worst ELO change in period)
        var topLoser = playerData.OrderBy(p => p.Value.TotalEloChange).FirstOrDefault();
        if (topLoser.Value != null && topLoser.Value.TotalEloChange < 0)
        {
            _filteredBadges.LastPlace = new BadgeHolder
            {
                PlayerId = topLoser.Key,
                PlayerName = topLoser.Value.Name,
                Value = topLoser.Value.TotalEloChange
            };
        }

        // Hot Streak (current streak at end of period)
        var hotStreak = playerData.Where(p => p.Value.CurrentStreak >= 3)
            .OrderByDescending(p => p.Value.CurrentStreak)
            .FirstOrDefault();
        if (hotStreak.Value != null)
        {
            _filteredBadges.HotStreak = new BadgeHolder
            {
                PlayerId = hotStreak.Key,
                PlayerName = hotStreak.Value.Name,
                Value = hotStreak.Value.CurrentStreak
            };
        }

        // Streak King (longest streak in period)
        var streakKing = playerData.Where(p => p.Value.LongestStreak >= 3)
            .OrderByDescending(p => p.Value.LongestStreak)
            .FirstOrDefault();
        if (streakKing.Value != null)
        {
            _filteredBadges.StreakKing = new BadgeHolder
            {
                PlayerId = streakKing.Key,
                PlayerName = streakKing.Value.Name,
                Value = streakKing.Value.LongestStreak
            };
        }

        // Best Win Rate
        var bestWinRate = playerData.Where(p => p.Value.TotalGames >= minGames)
            .OrderByDescending(p => (double)p.Value.Wins / p.Value.TotalGames)
            .FirstOrDefault();
        if (bestWinRate.Value != null)
        {
            var winRate = (int)((double)bestWinRate.Value.Wins / bestWinRate.Value.TotalGames * 100);
            _filteredBadges.BestWinRate = new BadgeHolder
            {
                PlayerId = bestWinRate.Key,
                PlayerName = bestWinRate.Value.Name,
                Value = winRate
            };
        }

        // Best Goalkeeper
        var bestGk = playerData.Where(p => p.Value.GkGames >= minGames)
            .OrderBy(p => (double)p.Value.GkGoalsConceded / p.Value.GkGames)
            .FirstOrDefault();
        if (bestGk.Value != null)
        {
            _filteredBadges.BestGoalkeeper = new BadgeHolder
            {
                PlayerId = bestGk.Key,
                PlayerName = bestGk.Value.Name,
                Value = (int)((double)bestGk.Value.GkGoalsConceded / bestGk.Value.GkGames * 10)
            };
        }

        // Best Attacker
        var bestAtk = playerData.Where(p => p.Value.AtkGames >= minGames)
            .OrderByDescending(p => (double)p.Value.AtkGoalsScored / p.Value.AtkGames)
            .FirstOrDefault();
        if (bestAtk.Value != null)
        {
            _filteredBadges.BestAttacker = new BadgeHolder
            {
                PlayerId = bestAtk.Key,
                PlayerName = bestAtk.Value.Name,
                Value = (int)((double)bestAtk.Value.AtkGoalsScored / bestAtk.Value.AtkGames * 10)
            };
        }

        // Table Divers (multi-holder)
        var maxUnderTable = playerData.Max(p => p.Value.UnderTableLosses);
        if (maxUnderTable > 0)
        {
            _filteredBadges.TableDivers = playerData
                .Where(p => p.Value.UnderTableLosses == maxUnderTable)
                .Select(p => new BadgeHolder
                {
                    PlayerId = p.Key,
                    PlayerName = p.Value.Name,
                    Value = maxUnderTable
                })
                .ToList();
        }

        // Table Senders (multi-holder)
        var maxTableSends = playerData.Max(p => p.Value.TableSends);
        if (maxTableSends > 0)
        {
            _filteredBadges.TableSenders = playerData
                .Where(p => p.Value.TableSends == maxTableSends)
                .Select(p => new BadgeHolder
                {
                    PlayerId = p.Key,
                    PlayerName = p.Value.Name,
                    Value = maxTableSends
                })
                .ToList();
        }

        // Tomko Memorial (multi-holder, min 4 games)
        var maxGamesInDay = playerData.Max(p => p.Value.GamesPerDay.Values.DefaultIfEmpty(0).Max());
        if (maxGamesInDay >= Constants.TimeThresholds.MinGamesForTomkoBadge)
        {
            _filteredBadges.TomkoMemorials = playerData
                .Where(p => p.Value.GamesPerDay.Values.DefaultIfEmpty(0).Max() == maxGamesInDay)
                .Select(p => new BadgeHolder
                {
                    PlayerId = p.Key,
                    PlayerName = p.Value.Name,
                    Value = maxGamesInDay
                })
                .ToList();
        }

        // Carried - most wins when partnered with higher ELO player (min 10 games)
        var qualifiedCarried = playerData
            .Where(p => p.Value.CarriedWins >= Constants.TimeThresholds.MinGamesForCarriedBadge)
            .ToList();

        if (qualifiedCarried.Count > 0)
        {
            var maxCarried = qualifiedCarried.Max(p => p.Value.CarriedWins);
            _filteredBadges.Carried = qualifiedCarried
                .Where(p => p.Value.CarriedWins == maxCarried)
                .Select(p => new BadgeHolder
                {
                    PlayerId = p.Key,
                    PlayerName = p.Value.Name,
                    Value = maxCarried
                })
                .ToList();
        }
    }

    private class PlayerBadgeData
    {
        public string Name { get; set; } = "";
        public int TotalGames { get; set; }
        public int Wins { get; set; }
        public int TotalEloChange { get; set; }
        public int CurrentStreak { get; set; }
        public int LongestStreak { get; set; }
        public int UnderTableLosses { get; set; }
        public int TableSends { get; set; }
        public int GkGames { get; set; }
        public int GkGoalsConceded { get; set; }
        public int AtkGames { get; set; }
        public int AtkGoalsScored { get; set; }
        public Dictionary<DateTime, int> GamesPerDay { get; set; } = [];
        public int CarriedWins { get; set; }
    }

    private async Task RenderCharts()
    {
        // ELO Distribution Bar Chart (always all-time)
        if (_rankings.Count > 0)
        {
            var eloLabels = _rankings.Select(r => r.PlayerName).ToArray();
            var eloData = _rankings.Select(r => r.Elo).ToArray();
            await JS.InvokeVoidAsync("renderBarChart", "eloDistributionChart", eloLabels, eloData, "ELO", "#198754");
        }

        // Win Rate Bar Chart (filtered)
        if (_filteredRankings.Count > 0)
        {
            var wrLabels = _filteredRankings.Where(r => r.Matches > 0).Select(r => r.PlayerName).ToArray();
            var wrData = _filteredRankings.Where(r => r.Matches > 0).Select(r => r.WinRate).ToArray();
            await JS.InvokeVoidAsync("renderBarChart", "winRateChart", wrLabels, wrData, "Win Rate %", "#0d6efd");

            // Games per Player Pie Chart (filtered)
            var gamesLabels = _filteredRankings.OrderByDescending(r => r.Matches).Select(r => r.PlayerName).ToArray();
            var gamesData = _filteredRankings.OrderByDescending(r => r.Matches).Select(r => r.Matches).ToArray();
            var pieColors = new[] { "#198754", "#0d6efd", "#6f42c1", "#fd7e14", "#20c997", "#e83e8c", "#ffc107", "#dc3545", "#6c757d", "#17a2b8" };
            await JS.InvokeVoidAsync("renderPieChart", "gamesPerPlayerChart", gamesLabels, gamesData, pieColors);
        }

        // Matches Over Time Line Chart
        if (_matchesOverTime.Count > 0)
        {
            var timeLabels = _matchesOverTime.Keys.ToArray();
            var timeData = _matchesOverTime.Values.ToArray();
            await JS.InvokeVoidAsync("renderLineChart", "matchesOverTimeChart", timeLabels, timeData, "Matches", "#fd7e14");
        }

        // Day of Week Bar Chart
        if (_dayOfWeekStats.Any(d => d > 0))
        {
            var dayLabels = new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
            await JS.InvokeVoidAsync("renderBarChart", "dayOfWeekChart", dayLabels, _dayOfWeekStats, "Matches", "#20c997");
        }

        // Most Common Pairs Horizontal Bar Chart
        if (_filteredPairStats.Count > 0)
        {
            var pairLabels = _filteredPairStats.Select(p => $"{p.Player1Name} & {p.Player2Name}").ToArray();
            var pairData = _filteredPairStats.Select(p => p.Matches).ToArray();
            await JS.InvokeVoidAsync("renderHorizontalBarChart", "commonPairsChart", pairLabels, pairData, "Matches", "#e83e8c");
        }
    }

    // Local classes for filtered data
    private class FilteredPlayerRanking
    {
        public int PlayerId { get; set; }
        public string PlayerName { get; set; } = "";
        public int AvatarId { get; set; }
        public int Matches { get; set; }
        public int Wins { get; set; }
        public double WinRate { get; set; }
    }

    private class FilteredPairStats
    {
        public string Player1Name { get; set; } = "";
        public string Player2Name { get; set; } = "";
        public int Matches { get; set; }
        public int Wins { get; set; }
    }

    private class FilteredBadges
    {
        public BadgeHolder? TopRated { get; set; }
        public BadgeHolder? HotStreak { get; set; }
        public BadgeHolder? StreakKing { get; set; }
        public BadgeHolder? BestGoalkeeper { get; set; }
        public BadgeHolder? BestAttacker { get; set; }
        public BadgeHolder? BestWinRate { get; set; }
        public BadgeHolder? LastPlace { get; set; }
        public List<BadgeHolder> TableDivers { get; set; } = [];
        public List<BadgeHolder> TableSenders { get; set; } = [];
        public List<BadgeHolder> TomkoMemorials { get; set; } = [];
        public List<BadgeHolder> Carried { get; set; } = [];
    }
}
