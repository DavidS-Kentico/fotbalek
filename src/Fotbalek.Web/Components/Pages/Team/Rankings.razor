@page "/{TeamCode}/rankings"
@layout TeamLayout
@rendermode InteractiveServer
@inject AuthService AuthService
@inject StatsService StatsService
@inject BadgeService BadgeService

<PageTitle>Rankings - Foosball Manager</PageTitle>

@if (_loading)
{
    <LoadingSpinner />
}
else
{
    <div class="container py-4">
        <h2 class="mb-4"><i class="bi bi-bar-chart me-2"></i>Rankings</h2>

        <!-- Player Rankings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-person me-2"></i>Player Rankings</h5>
            </div>
            <div class="card-body p-0">
                @if (_rankings.Count > 0)
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 60px;">Rank</th>
                                    <th>Player</th>
                                    <th class="text-end">ELO</th>
                                    <th class="text-end">Matches</th>
                                    <th class="text-end">Wins</th>
                                    <th class="text-end">Win Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var player in _rankings)
                                {
                                    <tr>
                                        <td class="text-center">
                                            <RankBadge Rank="@player.Rank" Large="true" />
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <a href="/@TeamCode/players/@player.PlayerId" class="text-decoration-none d-flex align-items-center gap-2">
                                                    <Avatar AvatarId="@player.AvatarId" Size="sm" />
                                                    <span>@player.PlayerName</span>
                                                </a>
                                                @foreach (var badge in BadgeService.GetPlayerBadges(player.PlayerId, _badges))
                                                {
                                                    <span class="badge @badge.CssClass px-1" title="@badge.Tooltip"><i class="@badge.IconClass"></i></span>
                                                }
                                            </div>
                                        </td>
                                        <td class="text-end fw-bold">@player.Elo</td>
                                        <td class="text-end">@player.Matches</td>
                                        <td class="text-end text-success">@player.Wins</td>
                                        <td class="text-end">
                                            <span class="@(player.WinRate >= 50 ? "text-success" : "text-danger")">
                                                @player.WinRate.ToString("F1")%
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-people fs-1 d-block mb-2"></i>
                        <p>No players yet.</p>
                    </div>
                }
            </div>
        </div>

        <!-- Pair Rankings -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>Best Pairs (min @Constants.TimeThresholds.MinGamesForPartnerStats matches)</h5>
            </div>
            <div class="card-body p-0">
                @if (_pairRankings.Count > 0)
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 60px;">Rank</th>
                                    <th>Players</th>
                                    <th class="text-end">Matches</th>
                                    <th class="text-end">W/L</th>
                                    <th class="text-end">Win Rate</th>
                                    <th class="text-end">Avg Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    var rank = 1;
                                }
                                @foreach (var pair in _pairRankings)
                                {
                                    <tr>
                                        <td class="text-center">
                                            <RankBadge Rank="@rank" Large="true" />
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <Avatar AvatarId="@pair.Player1AvatarId" Size="sm" />
                                                <span>@pair.Player1Name</span>
                                                <span class="text-muted">&</span>
                                                <Avatar AvatarId="@pair.Player2AvatarId" Size="sm" />
                                                <span>@pair.Player2Name</span>
                                            </div>
                                        </td>
                                        <td class="text-end">@pair.Matches</td>
                                        <td class="text-end">
                                            <span class="text-success">@pair.Wins</span>/<span class="text-danger">@pair.Losses</span>
                                        </td>
                                        <td class="text-end">
                                            <span class="@(pair.WinRate >= 50 ? "text-success" : "text-danger") fw-bold">
                                                @pair.WinRate.ToString("F1")%
                                            </span>
                                        </td>
                                        <td class="text-end">@pair.AverageScore.ToString("F1")</td>
                                    </tr>
                                    rank++;
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-people fs-1 d-block mb-2"></i>
                        <p>Not enough matches to rank pairs yet (minimum @Constants.TimeThresholds.MinGamesForPartnerStats matches per pair).</p>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string TeamCode { get; set; } = string.Empty;

    private Team? _team;
    private bool _loading = true;
    private List<PlayerRanking> _rankings = [];
    private List<PairStats> _pairRankings = [];
    private TeamBadges? _badges;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _team = await AuthService.GetCurrentTeamAsync();
            if (_team != null)
            {
                _rankings = await StatsService.GetRankingsAsync(_team.Id);
                _pairRankings = await StatsService.GetPairRankingsAsync(_team.Id);
                _badges = await StatsService.GetBadgesAsync(_team.Id);
            }
            _loading = false;
            StateHasChanged();
        }
    }
}
